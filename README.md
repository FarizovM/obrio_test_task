# OBRIO Test Task: Microservices Notification System

–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–∫–ª–∞–¥–µ–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å. –ü–æ–±—É–¥–æ–≤–∞–Ω–∞ –Ω–∞ –±–∞–∑—ñ **NestJS**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **Event-Driven Architecture** (RabbitMQ), **Delayed Jobs** (Redis) —Ç–∞ –≤–∫–ª—é—á–∞—î —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (**Prometheus**).

–°–∏—Å—Ç–µ–º–∞ —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∞ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º **Production Ready** –ø—Ä–∞–∫—Ç–∏–∫: –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó, —Å—Ç—ñ–π–∫—ñ—Å—Ç—å –¥–æ –∑–±–æ—ó–≤ (Retries, DLQ), –±–µ–∑–ø–µ–∫–∞ —Ç–∞ observability.

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π —Å—Ç–µ–∫

* **Core:** NestJS (Monorepo), TypeScript, Node.js (v20+ Alpine)
* **Database:** PostgreSQL (TypeORM)
* **Message Broker:** RabbitMQ (AMQP)
* **Job Queue:** Redis + BullMQ
* **Monitoring:** Prometheus (@willsoto/nestjs-prometheus)
* **Infrastructure:** Docker & Docker Compose
* **Security & Stability:** Helmet, Joi, Class-Validator, Graceful Shutdown

## üèó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –¥–≤–æ—Ö –Ω–µ–∑–∞–ª–µ–∂–Ω–∏—Ö –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤:

### 1. User Service (REST API)

* **Role:** –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤.
* **Features:**
  * REST API –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (`POST /users`).
  * –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö (DTO + ValidationPipe).
  * –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —É PostgreSQL (UUID).
  * –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ–¥—ñ—ó `user_created` —É RabbitMQ.
  * **Metrics:** –ï–∫—Å–ø–æ—Ä—Ç—É—î –±—ñ–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫—É `users_registered_total`.
  * **Security:** –ó–∞—Ö–∏—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —á–µ—Ä–µ–∑ `helmet`.

### 2. Notification Service (Worker + Hybrid)

* **Role:** –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω—å.
* **Features:**
  * –°–ª—É—Ö–∞—î —á–µ—Ä–≥—É RabbitMQ.
  * –°—Ç–≤–æ—Ä—é—î –≤—ñ–¥–∫–ª–∞–¥–µ–Ω—É –∑–∞–¥–∞—á—É (Delayed Job) —É Redis (–ø–∞—Ä–∞–º–µ—Ç—Ä `PUSH_DELAY_MS`).
  * –í–∏–∫–æ–Ω—É—î HTTP-–∑–∞–ø–∏—Ç –Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π Webhook (—ñ–º—ñ—Ç–∞—Ü—ñ—è Push).
  * **Resilience:**
    * **Retry Strategy:** 3 —Å–ø—Ä–æ–±–∏ –∑ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é, —è–∫—â–æ Webhook –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.
    * **Dead Letter Queue (DLQ):** –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫—ñ –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏, –Ω–µ –∑–Ω–∏–∫–∞—é—Ç—å, –∞ –ø–µ—Ä–µ–º—ñ—â—É—é—Ç—å—Å—è —É `dead_letter_notification_queue`.
    * **Manual ACKs:** –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏ —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.
  * **Metrics:** –ì—ñ–±—Ä–∏–¥–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ (AMQP + HTTP), –µ–∫—Å–ø–æ—Ä—Ç—É—î –º–µ—Ç—Ä–∏–∫—É `push_notifications_sent_total` –Ω–∞ –ø–æ—Ä—Ç—É 3001.

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É (Monorepo)

```
.
‚îú‚îÄ‚îÄ apps
‚îÇ   ‚îú‚îÄ‚îÄ user-service          # HTTP API, TypeORM, RabbitMQ Publisher
‚îÇ   ‚îî‚îÄ‚îÄ notification-service  # Microservice, RabbitMQ Consumer, BullMQ (Redis) Processor
‚îú‚îÄ‚îÄ docker-compose.yml        # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü—ñ—è —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏
‚îú‚îÄ‚îÄ Dockerfile                # Multi-stage build –¥–ª—è –æ–±–æ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
‚îú‚îÄ‚îÄ prometheus.yml            # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å–∫—Ä–∞–ø—ñ–Ω–≥—É –º–µ—Ç—Ä–∏–∫
‚îî‚îÄ‚îÄ .env                      # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
```

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç (Docker)

–î–ª—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—î–∫—Ç—É –ø–æ—Ç—Ä—ñ–±–µ–Ω –ª–∏—à–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π **Docker** —Ç–∞ **Docker Compose**.

### 1. –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é

```bash
git clone https://github.com/FarizovM/obrio_test_task.git
cd obrio_test_task
```

### 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä–∏–∫–ª–∞–¥—É `.env.example`

### 3. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤

–ó–±—ñ—Ä–∫–∞ —Ç–∞ –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏ —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ:

```bash
docker-compose up -d --build
```

–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É –±—É–¥—É—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç–∞–∫—ñ —Å–µ—Ä–≤—ñ—Å–∏:

* User Service API: <http://localhost:3000/users>
* PostgreSQL: localhost:5432
* RabbitMQ Management: <http://localhost:15672> (login: user, pass: password)
* pgAdmin: <http://localhost:5050> (login: <admin@admin.com>, pass: admin)

## üß™ API

–ú–µ—Ç–æ–¥: `POST`

```bash
http://localhost:3000/users
```

BODY:

```json
{
    "name": "Test User" 
}
```

–û—á—ñ–∫—É–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å `201 Created`:

```json
{
    "id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
    "name": "Test User",
    "createdAt": "2023-10-27T10:00:00.000Z"
}
```

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ (Prometheus)

–ü–µ—Ä–µ–π–¥—ñ—Ç—å —É Prometheus UI: <http://localhost:9090>

–°–ø—Ä–æ–±—É–π—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç–∞–∫—ñ –∑–∞–ø–∏—Ç–∏ —É –ø–æ–ª—ñ "Expression":

1. `users_registered_total` ‚Äî –ü–æ–∫–∞–∂–µ –∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.
2. `push_notifications_sent_total` ‚Äî –ü–æ–∫–∞–∂–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –ø—É—à—ñ–≤.
3. `nodejs_eventloop_lag_seconds` ‚Äî –°—Ç–∞–Ω –∑–¥–æ—Ä–æ–≤'—è Node.js –ø—Ä–æ—Ü–µ—Å—É.

## üõ° Production Ready Features (–î–µ—Ç–∞–ª—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó)

1. *Graceful Shutdown*: –í –æ–±–æ—Ö —Å–µ—Ä–≤—ñ—Å–∞—Ö –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ app.enableShutdownHooks(). –ü—Ä–∏ –∑—É–ø–∏–Ω—Ü—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (docker stop), –¥–æ–¥–∞—Ç–æ–∫ –∫–æ—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä–∏–≤–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –ë–î, RabbitMQ —Ç–∞ –∑–∞–≤–µ—Ä—à—É—î –ø–æ—Ç–æ—á–Ω—ñ HTTP –∑–∞–ø–∏—Ç–∏, –∑–∞–ø–æ–±—ñ–≥–∞—é—á–∏ –≤—Ç—Ä–∞—Ç—ñ –¥–∞–Ω–∏—Ö.
2. *Config Validation (Joi)*: –°–µ—Ä–≤—ñ—Å–∏ –Ω–µ –∑–∞–ø—É—Å—Ç—è—Ç—å—Å—è, —è–∫—â–æ –≤ .env –≤—ñ–¥—Å—É—Ç–Ω—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –∑–º—ñ–Ω–Ω—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, RABBITMQ_URL –∞–±–æ WEBHOOK_URL). –¶–µ —Ä–µ–∞–ª—ñ–∑—É—î –ø—Ä–∏–Ω—Ü–∏–ø "Fail Fast".
3. *RabbitMQ Reliability*:
    * Durable —á–µ—Ä–≥–∏.
    * –ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π Dead Letter Exchange (DLX). –Ø–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–∫–ª–∏–∫–∞—î –∫—Ä–∏—Ç–∏—á–Ω—É –ø–æ–º–∏–ª–∫—É, –≤–æ–Ω–æ –ø–æ—Ç—Ä–∞–ø–ª—è—î –≤ —á–µ—Ä–≥—É dead_letter_notification_queue –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–æ–º.
4. *Redis Resilience*: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–∞—Ç–µ—Ä–Ω Backoff –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–± HTTP –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –≤–µ–±—Ö—É–∫–∞. –£ —Ä–∞–∑—ñ –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ –∑–±–æ—é —Å–µ—Ä–≤—ñ—Å —Å–ø—Ä–æ–±—É—î –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø—É—à —â–µ 3 —Ä–∞–∑–∏ –∑ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥.
5. *Multi-stage Docker Build*: –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π Dockerfile –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –µ—Ç–∞–ø–∏ builder —Ç–∞ production, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–º–µ–Ω—à–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É, –≤–∏–¥–∞–ª—è—é—á–∏ devDependencies —Ç–∞ –≤–∏—Ö—ñ–¥–Ω–∏–π –∫–æ–¥ TS.
